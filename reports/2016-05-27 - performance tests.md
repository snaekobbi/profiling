Performance test 2016-05-27
===========================

Time spent in seconds between the given progress message and the
next progress message (regardless of progress message depth).

## Book 552739: filesize 0.5 MB

Full log: [job-258.log](2016-05-27/job-258.log)  
Progress message log: [progress-258.log](2016-05-27/progress-258.log)  

- 76.137 `[progress pxi:css-to-obfl.split-sections.section 50 css:split]` Page and volume split.
- 67.783 `[progress px:dotify-transform 27 px:transform]`
- 17.887 `[progress pxi:css-to-obfl.for-each-margin-attributes.item 10 p:delete]` Remove text nodes from block boxes with no line boxes.
- 12.984 `[progress pxi:css-to-obfl 1 css:shift-id]` Move css:id attributes to css:box elements.
- 10.915 `[progress pxi:css-to-obfl 1 pxi:shift-obfl-marker]` Move css:_obfl-marker attributes.
- 5.627 `[progress pxi:css-to-obfl 14 css:shift-string-set]` Move css:string-set attributes.
- 4.861 `[progress px:dotify-transform 1 pxi:obfl-normalize-space]`
- 4.737 `[progress px:dotify-transform 2 dotify:obfl-to-pef]`
- 3.537 `[progress pxi:css-to-obfl.pages-and-volumes 1/44]`
- 1.799 `[progress pxi:css-to-obfl 1 pxi:recursive-parse-stylesheet-and-make-pseudo-elements]` Recursively parse stylesheet and make pseudo elements
- 1.295 `[progress pef:store 80 px:pef-to-html.convert]` Converting PEF to HTML preview using the BRF table '(locale:no)'

## Book 553184: filesize 1 MB

Full log: [job-259.log](2016-05-27/job-259.log)
Progress message log: [progress-259.log](2016-05-27/progress-259.log)  

- 165.05 `[progress pxi:css-to-obfl.split-sections.section 50 css:split]` Page and volume split.
- 83.832 `[progress px:dotify-transform 27 px:transform]`
- 25.289 `[progress pxi:css-to-obfl 1 css:shift-id]` Move css:id attributes to css:box elements.
- 22.234 `[progress pxi:css-to-obfl.for-each-margin-attributes.item 10 p:delete]` Remove text nodes from block boxes with no line boxes.
- 18.996 `[progress pxi:css-to-obfl 1 pxi:shift-obfl-marker]` Move css:_obfl-marker attributes.
- 14.799 `[progress px:dotify-transform 1 pxi:obfl-normalize-space]`
- 10.966 `[progress pxi:css-to-obfl 14 css:shift-string-set]` Move css:string-set attributes.
- 7.091 `[progress px:dotify-transform 2 dotify:obfl-to-pef]`
- 3.598 `[progress pxi:css-to-obfl.pages-and-volumes 1/48]`
- 1.91 `[progress pxi:css-to-obfl 1 pxi:recursive-parse-stylesheet-and-make-pseudo-elements]` Recursively parse stylesheet and make pseudo elements
- 1.663 `[progress pef:store 80 px:pef-to-html.convert]` Converting PEF to HTML preview using the BRF table '(locale:no)'

## Book 554664: filesize 2.4 MB

Full log: [job-260.log](2016-05-27/job-260.log)
Progress message log: [progress-260.log](2016-05-27/progress-260.log)  

- 832.405 `[progress pxi:css-to-obfl.split-sections.section 50 css:split]` Page and volume split.
- 514 `[progress pxi:css-to-obfl.for-each-margin-attributes.item 10 p:delete]` Remove text nodes from block boxes with no line boxes.
- 220.268 `[progress pxi:css-to-obfl 1 css:shift-id]` Move css:id attributes to css:box elements.
- 200.515 `[progress px:dotify-transform 27 px:transform]`
- 163.869 `[progress pxi:css-to-obfl 1 pxi:shift-obfl-marker]` Move css:_obfl-marker attributes.
- 120.736 `[progress px:dotify-transform 1 pxi:obfl-normalize-space]`
- 85.618 `[progress pxi:css-to-obfl 14 css:shift-string-set]` Move css:string-set attributes.
- 19.549 `[progress px:dotify-transform 2 dotify:obfl-to-pef]`
- 10.368 `[progress pxi:css-to-obfl 1 css:label-targets]` Make css:id attributes.
- 7.693 `[progress pxi:css-to-obfl.for-each-margin-attributes.item 20 css:new-definition]` New definition.
- 4.735 `[progress pef:store 80 px:pef-to-html.convert]` Converting PEF to HTML preview using the BRF table '(locale:no)'
- 4.553 `[progress pxi:css-to-obfl.pages-and-volumes 1/31]`
- 4.481 `[progress pxi:css-to-obfl 1 pxi:recursive-parse-stylesheet-and-make-pseudo-elements]` Recursively parse stylesheet and make pseudo elements
- 2.939 `[progress pxi:css-to-obfl 1 css:eval-target-content]` Evaluate css:content elements.
- 2.499 `[progress for-each.parse-properties-and-eval-string-set.iteration 50 css:parse-properties]`
- 2.309 `[progress pxi:css-to-obfl 10]` add `<marker class="foo/prev"/>`
- 2.038 `[progress pxi:css-to-obfl 1 css:flow-into]` Extract named flows based on css:flow attributes.
- 1.779 `[progress pxi:css-to-obfl.for-each-parse-preserve-table-box.part 20 css:parse-properties]`
- 1.705 `[progress pxi:css-to-obfl 1 css:parse-properties]` Make css:display, css:render-table-by and css:table-header-policy attributes.
- 1.684 `[progress pxi:css-to-obfl.for-each-parse-preserve-table-box.part 20 css:make-boxes]` Make css:box elements based on css:display and css:list-style-type attributes.
- 1.526 `[progress pxi:css-to-obfl.for-each-anonymous-inline-boxes 1/4 css:make-anonyous-inline-boxes]`
- 1.244 `[progress pxi:css-to-obfl.for-each-parse-preserve-table-box.part 20 css:parse-properties]` Make css:white-space, css:display, css:list-style-type, css:page-break-before and css:page-break-after attributes.
- 1.206 `[progress pxi:css-to-obfl.foreach-parse-properties 1/1 css:parse-properties]`
- 1.027 `[progress pxi:css-to-obfl 2 css:parse-content]`

## Review

Time spent on each step listed in the order of filesize (i.e. book 552739, book 553184 and book 554664),
as well as the time per megabyte of input data this step takes.

### O(1): These seem fairly independent of the input filesize:

`[progress pef:store 80 px:pef-to-html.convert]` Converting PEF to HTML preview using the BRF table '(locale:no)'
    - 1.295 (2.59 s/MB)
    - 1.663 (1.663 s/MB)
    - 4.735 (1.972 s/MB)

`[progress pxi:css-to-obfl 1 pxi:recursive-parse-stylesheet-and-make-pseudo-elements]` Recursively parse stylesheet and make pseudo elements
    - 1.799 (3.598 s/MB)
    - 1.910 (1.910 s/MB)
    - 4.481 (1.867 s/MB)

### O(n): These seem to have a linear correlation with the input filesize:

`[progress px:dotify-transform 2 dotify:obfl-to-pef]`
    - 4.737 (9.474 s/MB)
    - 7.091 (7.091 s/MB)
    - 19.549 (8.145 s/MB)

`[progress px:dotify-transform 27 px:transform]`
    - 67.783 (135.566 s/MB)
    - 83.832 (83.832 s/MB)
    - 200.515 (83.547 s/MB)

### These seem to have a non-linear correlation (polynomial or exponential) with the input filesize:

`[progress pxi:css-to-obfl 14 css:shift-string-set]` Move css:string-set attributes.
    - 5.627 (11.254 s/MB)
    - 10.966 (10.966 s/MB)
    - 85.618 (35.674 s/MB)

`[progress px:dotify-transform 1 pxi:obfl-normalize-space]`
    - 4.861 (9.722 s/MB)
    - 14.799 (14.799 s/MB)
    - 120.736 (50.306 s/MB)

`[progress pxi:css-to-obfl 1 pxi:shift-obfl-marker]` Move css:_obfl-marker attributes.
    - 10.915 (21.83 s/MB)
    - 18.996 (18.996 s/MB)
    - 163.869 (68.278 s/MB)

`[progress pxi:css-to-obfl 1 css:shift-id]` Move css:id attributes to css:box elements.
    - 12.984 (25.968 s/MB)
    - 25.289 (25.289 s/MB)
    - 220.268 (91.778 s/MB)
    - 97% of the time spent are at p:label-elements here: https://github.com/daisy/pipeline-mod-braille/blob/c108040b4dc4669ec8d8bc82e800967e1f8efdb3/pipeline-braille-utils/css-utils/css-utils/src/main/resources/xml/shift-id.xpl#L32

`[progress pxi:css-to-obfl.for-each-margin-attributes.item 10 p:delete]` Remove text nodes from block boxes with no line boxes.
    - 17.887 (35.774 s/MB)
    - 22.234 (22.234 s/MB)
    - 514.000 (214.166 s/MB)
    - 99.9% of the time spent are at p:delete here: https://github.com/daisy/pipeline-mod-braille/blob/c108040b4dc4669ec8d8bc82e800967e1f8efdb3/pipeline-braille-utils/dotify-utils/dotify-formatter/src/main/resources/xml/css-to-obfl.xpl#L564

`[progress pxi:css-to-obfl.split-sections.section 50 css:split]` Page and volume split.
    - 76.137 (152.274 s/MB)
    - 165.050 (165.050 s/MB)
    - 832.405 (346.835 s/MB)
    - 95% of the time spent are at p:delete here: https://github.com/daisy/pipeline-mod-braille/blob/c108040b4dc4669ec8d8bc82e800967e1f8efdb3/pipeline-braille-utils/css-utils/css-utils/src/main/resources/xml/split.xpl#L67

Maybe try rewriting the problematic p:lavel-elements and p:delete in XSLT?
